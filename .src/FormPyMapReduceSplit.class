' Gambas class file

Public pymapreduce_editor As Editor

Public Sub _new()
  ' make editor visible
  pymapreduce_editor = EditorPyMapReduce
End

Public Sub Form_Open()
  VSplitMain.Settings = [1, 1]
  EditorPyMapReduce.Flags[EditorPyMapReduce.ShowLineNumbers] = True
End

Public Sub ToolButtonExecute_Click()
' execute the query and show the results
  Dim results As Variant
  TreeViewResult.Clear
  Try results = FMain.db.query(EditorPyMapReduce.Text)
  If Error Then
    Message.Error(Error.Text)
    Return
  Endif
  TreeViewResult.tag = FMain.db.query("len(picklers) - 1")
  FMain.db.construct_object_tree(results, Null, TreeViewResult)
  TreeViewResult_Expand()
  FMain.db.dbobjects["queries"]["pymapreduce queries"][Left$(FMain.main_tabstrip.Text, - Len(" - PyMapReduce query"))] = EditorPyMapReduce.Text
  FMain.db.save()
  FMain.db.refresh_db_tree()
End

Public Sub ToolButtonClose_Click()
  ' close the current tab
  Dim child As Variant
  If Message.Question("Save the query?", "Yes", "No") = 1 Then
    FMain.db.dbobjects["queries"]["pymapreduce queries"][Left$(FMain.main_tabstrip.Text, - Len(" - PyMapReduce query"))] = EditorPyMapReduce.Text
    FMain.db.save()
  Endif
  With FMain.main_tabstrip.Current
    For Each child In .Children
      child.Close
    Next
    .Delete
  End With
End

Public Sub EditorPyMapReduce_KeyPress_()
  ' handle copy, paste, cut, select all
  If Key.Code = Key["C"] And If Key.Control Then
    EditorPyMapReduce.Copy()
  Else
    If Key.Code = Key["V"] And If Key.Control Then
      EditorPyMapReduce.Paste()
    Else
      If Key.Code = Key["X"] And If Key.Control Then
        EditorPyMapReduce.Cut()
      Else
        If Key.Code = Key["A"] And If Key.Control Then
          EditorPyMapReduce.SelectAll()
        Endif
      Endif
    Endif
  Endif
End

Public Sub TreeViewResult_Expand()
  Dim object As Variant
  Dim save_key, save_dict_key As String
  If FMain.db Is ZODB Then
    save_key = TreeViewResult.Item.Key
    TreeViewResult.MoveFirst()
    Repeat
      If TreeViewResult.Item.ParentKey = save_key Then
        save_dict_key = TreeViewResult.Item.Key
        TreeViewResult.MoveChild()
        If Not IsNull(TreeViewResult.Item) Then
          If TreeViewResult.Item.Text = "py/id" Then
            TreeViewResult.MoveChild()
            object = FMain.db.query("picklers[" & TreeViewResult.Tag & "].baze_objects[" & TreeViewResult.Item.Text & "]")
            FMain.db.construct_object_tree(object, save_key, TreeViewResult)
            TreeViewResult.Remove(save_dict_key)
            TreeViewResult.MoveFirst()
          Endif
        Endif
      Endif
    Until TreeViewResult.MoveBelow()
  Endif
End
